<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.Eparking.dao.ParkingLotOwnerMapper">


    <select id="getListPloByParkingStatusWithPagination" resultType="com.project.Eparking.domain.PLO">
        SELECT
            ploID,
            balance,
            phoneNumber,
            fullName,
            password,
            email,
            status,
            identify,
            parkingName,
            description,
            address,
            latitude,
            longtitude,
            parkingStatusID,
            slot,
            currentSlot,
            role,
            length,
            width,
            waitingTime,
            cancelBookingTime,
            contractLink,
            registerContract,
            browseContract,
            contractDuration,
            star
        FROM
            plo
        WHERE
            parkingStatusID
        IN
        <foreach collection="parkingStatus" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
        <if test="keywords != null and keywords != ''">
            AND (
            fullName REGEXP #{keywords} OR
            parkingName REGEXP #{keywords} OR
            phoneNumber REGEXP #{keywords} OR
            address REGEXP #{keywords} )
        </if>
        ORDER BY
            registerContract DESC
        LIMIT
            #{pageSize}
        OFFSET
            #{pageNum};
    </select>

    <select id="getPloById" resultType="com.project.Eparking.domain.PLO">
        SELECT
            ploID,
            balance,
            phoneNumber,
            fullName,
            password,
            email,
            status,
            identify,
            parkingName,
            description,
            address,
            latitude,
            longtitude,
            parkingStatusID,
            slot,
            currentSlot,
            role,
            length,
            width,
            waitingTime,
            cancelBookingTime,
            contractLink,
            registerContract,
            browseContract,
            contractDuration,
            star
        FROM
            plo
        WHERE
            ploID = #{ploId};
    </select>

    <select id="getListPloByKeywordsWithPagination" resultType="com.project.Eparking.domain.PLO">
        SELECT
            ploID,
            balance,
            phoneNumber,
            fullName,
            password,
            email,
            status,
            identify,
            parkingName,
            description,
            address,
            latitude,
            longtitude,
            parkingStatusID,
            slot,
            currentSlot,
            role,
            length,
            width,
            waitingTime,
            cancelBookingTime,
            contractLink,
            registerContract,
            browseContract,
            contractDuration,
            star
        FROM
            plo
        WHERE
            parkingStatusID
        IN
        <foreach collection="parkingStatus" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND (
            fullName REGEXP #{keyword} OR
            phoneNumber REGEXP #{keyword} OR
            parkingName REGEXP #{keyword} OR
            address REGEXP #{keyword} )
        LIMIT
            #{pageSize}
        OFFSET
            #{pageNum};
    </select>

    <update id="updateParkingStatusByPloId" parameterType="com.project.Eparking.domain.PLO">
        UPDATE plo
        SET
            parkingStatusID = #{parkingStatusID},
            browseContract = #{browseContract},
            contractDuration = #{contractDuration},
            contractLink = #{contractLink}
<!--            latitude = #{latitude},-->
<!--            longtitude = #{longtitude}-->
        WHERE ploID = #{ploID}
    </update>

    <select id="countRecords" resultType="java.lang.Integer">
        SELECT
            COUNT(*)
        FROM
            plo
        <if test="parkingStatus != null and parkingStatus.size() > 0">
            WHERE
                parkingStatusID
            IN
                <foreach collection="parkingStatus" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
        </if>
        <if test="keywords != null and keywords != ''">
            AND (
            fullName REGEXP #{keywords} OR
            phoneNumber REGEXP #{keywords} OR
            parkingName REGEXP #{keywords} OR
            address REGEXP #{keywords} )
        </if>
    </select>

    <update id="updatePloBalanceById" parameterType="map">
        UPDATE
            plo
        SET
            balance = #{balance}
        WHERE
            ploID = #{ploID}
    </update>
    <select id="countRecordsByWeekPLO" resultType="com.project.Eparking.domain.response.Response4week">
        <![CDATA[
            SELECT
                IFNULL(SUM(CASE WHEN browseContract >= DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 0 WEEK)
                              AND browseContract < DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 1 WEEK) THEN 1 ELSE 0 END), 0) AS Week1,

                IFNULL(SUM(CASE WHEN browseContract >= DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 1 WEEK)
                              AND browseContract < DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 2 WEEK) THEN 1 ELSE 0 END), 0) AS Week2,

                IFNULL(SUM(CASE WHEN browseContract >= DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 2 WEEK)
                              AND browseContract < DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 3 WEEK) THEN 1 ELSE 0 END), 0) AS Week3,

                IFNULL(SUM(CASE WHEN browseContract >= DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 3 WEEK)
                              AND browseContract < DATE_ADD(STR_TO_DATE(CONCAT(#{year}, '-', #{month}, '-01 00:00:00'), '%Y-%m-%d'), INTERVAL 4 WEEK) THEN 1 ELSE 0 END), 0) AS Week4
            FROM plo
            WHERE MONTH(browseContract) = MONTH(#{inputDate}) AND YEAR(browseContract) = YEAR(#{inputDate});
        ]]>
    </select>

    <update id="updatePloBalanceAndCurrentSlotById" parameterType="map">
        UPDATE
            plo
        SET
            balance = #{balance},
            currentSlot = #{currentSlot}
        WHERE
            ploID = #{ploID}
    </update>
</mapper>